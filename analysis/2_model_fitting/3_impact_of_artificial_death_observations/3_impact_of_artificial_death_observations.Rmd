---
title: "Impact of artificial death observations"
author: "Andrew Pollard"
date: "16/12/2021"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library("here")
library("dplyr")
library("readr")
library("foreach")
library("doParallel")
library("glue")
library("msm")

source(here("src_R", "utils.R"))
source(here("src_R", "model.R"))
```


```{r read_train_data}
enroll_train_path <- here("data", "processed", "enroll_all_train.csv")
enroll_train <- read_csv(enroll_train_path)
```


```{r find_death_times_and_last_visit_ages}
death_ages_and_last_visits <- get_death_ages_and_last_visits(enroll_train)

T_i_all <- death_ages_and_last_visits$T_i
T_j_all <- death_ages_and_last_visits$T_j

```

## Derivation of approximation to MLE of life expectancy

Suppose we are fitting a 2-state model,
i.e. alive and dead,
and we have $m$ subjects with known exact death times
$T_1, T_2, \dots, T_m$,
and $n$ interval-censored death observations at $(T_j,T_\max]$,
for $j = m+1, \dots, m+n$.

Let $q$ be the transition intensity from alive to dead.
Then the likelihood of this data is

\begin{eqnarray}
L(q;\mathbf{T},T_\max) &=& q^m \exp\left\{-q\sum_{i=1}^m T_i\right\}
\times \prod_{j=m+1}^{m+n} \left(e^{-qT_j} - e^{-qT_\max}\right) \\

&=& q^m \exp\left\{-q\sum_{i=1}^{m+n}T_i\right\} \times
\prod_{j=m+1}^{m+n} \left(1 - e^{-q(T_\max - T_j)}\right)

\end{eqnarray}

Now looking at the log-likelihood, we have

$$
\ell(q;\mathbf{T},T_\max) = m\log q - q\sum_{i=1}^{m+n}T_i
 + \sum_{j=m+1}^{m+n}\log\left(1 - e^{-q(T_\max - T_j)}\right)
$$

Taking the derivative with respect to $q$ yields

$$
\frac{\partial\ell}{\partial q} = \frac{m}{q} - \sum_{i=1}^{m+n}T_i
 + \sum_{j=m+1}^{m+n} \frac{(T_\max - T_j) e^{-q(T_\max - T_j)}}{1 - e^{-q(T_\max - T_j)}}
$$
Now we can write the summand of the last sum as

$$
\frac{(T_\max - T_j) e^{-q(T_\max - T_j)}}{1 - e^{-q(T_\max - T_j)}} =
\frac{1}{q} \frac{xe^{-x}}{1 - e^{-x}},
$$

where $x = q(T_\max - T_j)$.

Provided $x$ is not too large,
we can approximate the above expression using
the first few terms of the Taylor series expansion:

$$
\frac{xe^{-x}}{1 - e^{-x}} = 1 - \frac{x}{2} + \frac{x^2}{12} + O(x^4)
$$

(n.b. the coefficient of $x^3$ is zero).

Substituting this approximation gives us

$$
\frac{\partial\ell}{\partial q} \approx \frac{m}{q} - \sum_{i=1}^{m+n}T_i
+ \sum_{j=m+1}^{m+n}\frac{1}{q}\left(1 - \frac{q}{2}(T_\max - T_j) +
\frac{q^2}{12}(T_\max - T_j)^2\right)
$$

Setting this equal to zero and rearranging yields
a quadratic equation for $q$:

$$
aq^2 + bq + c = 0,
$$

where

\begin{eqnarray}
a &=& \frac{1}{12}\sum_{j=m+1}^{m+n}(T_\max - T_j)^2 \\
b &=& -\sum_{i=1}^m T_i - \frac{1}{2}\sum_{j=m+1}^{m+n}T_j - \frac{1}{2}nT_\max \\
c &=& m + n
\end{eqnarray}

We want to select the root that gives
the best approximation to the true solution
of the likelihood equation.
As the 2nd-order Taylor series approximation
is only valid in the region where
$1 - \frac{q}{2}(T_\max - T_j) + \frac{q^2}{12}(T_\max - T_j)^2$
is decreasing,
it follows that the smaller root of $aq^2 + bq + c = 0$
is the right one,
because $aq^2 + bq + c$ is decreasing at the smaller root,
but increasing at the larger root.
Hence, the approximate MLE for $q$ is

$$
\hat{q} = \frac{-b - \sqrt{b^2 - 4ac}}{2a}
$$
The approximation to the MLE of the life expectancy
is then given by

$$
\hat{T}_\text{LE} = \frac{1}{\hat{q}}
$$


## Correcting the life expectancy bias

The Enroll data set has very few recorded dates of death,
so that the survival data is right-censored
for the vast majority of patients.
Such a high level of right-censoring leads to a bias,
in the form of a large overestimation of life expectancy,
even beyond any human lifetime.

We could only include patients whose dates of death are known,
but this would reduce our data set size drastically,
and would lead to underestimation of the life expectancy,
due to the selection bias of keeping this subset of patients.

In order to correct the overestimation of life expectancy
introduced by the model,
we can find a suitable $T_\max$ for which
the estimated life expectancy $T_\text{LE}$
equals particular value $T_\text{LE}^*$.
The value of $T_\text{LE}^*$ can then be set equal
to the estimated life expectancy of HD patients from previous studies,
which provides the model with
information beyond what is contained in Enroll.

To do this,
we set $q^* = 1/T_\text{LE}^*$
in the above approximation for $\frac{\partial\ell}{\partial q}$,
set this equal to zero,
and solve for $T_\max$.

The resulting value of $T_\max$ to use in the model
is given by the lower root of

$$
AT_\max^2 + BT_\max + C = 0,
$$

where

\begin{eqnarray}
A &=& \frac{1}{12}q^{*2} n \\
B &=& -\frac{1}{2}q^* \left(\frac{1}{3}q^*\sum_{j=m+1}^{m+n}T_j + n\right) \\
C &=& \frac{1}{12}q^{*2}\sum_{j=m+1}^{m+n}T_j^2 - q^*\left(\sum_{i=1}^m T_i + \frac{1}{2}\sum_{j=m+1}^{m+n}T_j\right) + m + n
\end{eqnarray}

and

$$
q^* = \frac{1}{T_\text{LE}^*}
$$

I.e.

$$
T_\max^* = \frac{-B - \sqrt{B^2 - 4AC}}{2A}
$$





## Plot approximate life expectancy MLE for a range of inputs

```{r define_life_expectancy_approx_function}
life_expectancy_approx <- function(T_i, T_j, T_max) {
    m <- length(T_i)
    n <- length(T_j)
    A <- 1/12 * sum((T_max - T_j)^2)
    B <- -sum(T_i) - 1/2 * sum(T_j) - n/2 * T_max
    C <- m + n
    
    q_hat <- (-B - sqrt(B^2 - 4*A*C)) / (2*A)
    life_expectancy_est <- 1 / q_hat
    
    return(life_expectancy_est)
}
```

The plot below shows how the artificial maximum age of death $T_\max$
relates to the estimated life expectancy $\hat{T}_\text{LE}$.

```{r plot_life_exp_vs_age_max}
plot_data <- tibble(
    T_max = 1:100,
    life_expectancy = sapply(T_max, function(x) life_expectancy_approx(T_i_all, T_j_all, x))
)

g <- ggplot(plot_data, aes(x = T_max, y = life_expectancy)) +
    geom_line()

print(g)
```

The plot below shows how this varies
with different numbers of observed deaths
and censored observations.

```{r set_up_plot_data, cache = TRUE}
plot_data <- expand.grid(
    m = seq_along(T_i_all),
    n = seq(50, 1000, by = 50),
    T_max = seq(80, 100, by = 2),
    life_expectancy_est = NA
)

cl <- makeCluster(detectCores())
registerDoParallel(cl)

plot_data[['life_expectancy_est']] <-
    foreach(i_row = seq_len(nrow(plot_data)), .combine = c) %dopar% {
        life_expectancy_approx(T_i_all[seq_len(plot_data[i_row, 'm'])],
                               T_j_all[seq_len(plot_data[i_row, 'n'])],
                               plot_data[i_row, 'T_max'])
    }

stopCluster(cl)
```

```{r plot_results, fig.width = 16, fig.height = 12}
g <- ggplot(plot_data, aes(x = m, y = n)) +
    geom_contour_filled(aes(z = life_expectancy_est)) +
    facet_wrap(vars(T_max)) +
    theme(text = element_text(size = 20)) +
    labs(x = "Number of actual death observations",
         y = "Number of artificial death observations",
         title = "Approximate MLE life expectancy",
         subtitle = "Panels correspond to different ages for artificial death observations")

print(g)
```
